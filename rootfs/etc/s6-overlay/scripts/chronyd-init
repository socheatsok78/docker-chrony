#!/bin/bash
set -e
ME=$(basename $0)
CHRONY_CONF_FILE="/etc/chrony/chrony.conf"
DEFAULT_NTP_SERVER_NTS=${DEFAULT_NTP_SERVER_NTS:-"false"}
DEFAULT_NTP_SERVER_ADDR=${DEFAULT_NTP_SERVER_ADDR:-"pool.ntp.org"}

# Generate a default chrony configuration file
{
  echo "# chrony.conf file generated by $ME script"
  echo "# https://github.com/socheatsok78/docker-chrony"
  echo
  echo "driftfile /var/lib/chrony/chrony.drift"
  echo "makestep 0.1 3"
  if [ "${NOCLIENTLOG:-false}" = true ]; then
    echo "noclientlog"
  fi
  echo "allow all"
  echo
} > ${CHRONY_CONF_FILE}

# If NTP_SERVER_COUNT is not set, add the default NTP_SERVER
if [ -z "${NTP_SERVER_COUNT}" ]; then
  NTP_SERVER_COUNT=1
  NTP_SERVER_1_NTS="${DEFAULT_NTP_SERVER_NTS}"
  NTP_SERVER_1_ADDR="${DEFAULT_NTP_SERVER_ADDR}"
fi

# Loop for the number of NTP_SERVER_COUNT and add the NTP_SERVER_#_ADDR to the chrony.conf
for i in $(seq 1 ${NTP_SERVER_COUNT}); do
  NTP_SERVER_ADDR_VAR="NTP_SERVER_${i}_ADDR"
  NTP_SERVER_NTS_VAR="NTP_SERVER_${i}_NTS"
  NTP_SERVER_ADDR="${!NTP_SERVER_ADDR_VAR}"
  NTP_SERVER_ADDR_CLEANED=${NTP_SERVER_ADDR//\"}
  NTP_SERVER_NTS="${!NTP_SERVER_NTS_VAR}"

  if [[ -z "${NTP_SERVER_ADDR}" ]]; then
    2>&1 echo "==> $ME: ERROR: NTP_SERVER_${i}_ADDR is not set, skipping..."
    continue
  fi

  if [[ "${NTP_SERVER_ADDR_CLEANED}" == "127\."* ]]; then
    echo "# ${NTP_SERVER_ADDR_VAR}" >> ${CHRONY_CONF_FILE}
    echo "server "${NTP_SERVER_ADDR_CLEANED} >> ${CHRONY_CONF_FILE}
    echo "local stratum 10"    >> ${CHRONY_CONF_FILE}
  else
    echo "# ${NTP_SERVER_ADDR_VAR}" >> ${CHRONY_CONF_FILE}
    if [[ "${NTP_SERVER_NTS:-false}" = true ]]; then
      echo "server "${NTP_SERVER_ADDR_CLEANED}" iburst nts" >> ${CHRONY_CONF_FILE}
    else
      echo "server "${NTP_SERVER_ADDR_CLEANED}" iburst" >> ${CHRONY_CONF_FILE}
    fi
  fi
done
